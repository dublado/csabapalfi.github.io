<!doctype html><html lang="en"><head><meta charset="utf-8"><title>Acceptance testing a Dropwizard app with Cucumber</title><meta name="viewport" content="width=device-width,initial-scale=1"></head><body><style>.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#333;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body a{background-color:transparent;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{font-size:2em;margin:.67em 0}.markdown-body img{border-style:none}.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body *{box-sizing:border-box}.markdown-body a{color:#4078c0;text-decoration:none}.markdown-body a:active,.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h3{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px;font-weight:600}.markdown-body h3{font-size:20px;font-weight:600}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body pre{margin-top:0;margin-bottom:0;font:12px Consolas,Liberation Mono,Menlo,Courier,monospace}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body p,.markdown-body pre{margin-top:0;margin-bottom:16px}.markdown-body h1,.markdown-body h3{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h3{font-size:1.25em}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body pre{word-wrap:normal}.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#4078c0;border:1px solid #4078c0}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment{color:#998;font-style:italic}.hljs-keyword{color:#333;font-weight:700}.hljs-string{color:#d14}.hljs-title{color:#900;font-weight:700}.hljs-meta{color:#999;font-weight:700}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media screen and (max-width:480px){.markdown-body{padding:15px}}.markdown-body .heading-anchor{color:inherit}</style><article class="markdown-body"><h1>Acceptance testing a Dropwizard app with Cucumber</h1><p><a href="https://csabapalfi.github.io">Csaba Palfi</a>, Mar 2014</p><p><strong><a href="http://www.dropwizard.io/">Dropwizard</a></strong> is a &apos;damn <strong>simple</strong> library for building production-ready <strong>RESTful</strong> web services&apos;. It&apos;s an opininated selection of a number of <strong>lightweight</strong> Java libraries and wonderful for building <strong>microservices</strong>. The <a href="http://www.thoughtworks.com/radar">ThoughtWorks Tech Radar</a> now also <a href="http://www.thoughtworks.com/radar/#/languages-and-frameworks/519">has it in it&apos;s adopt circle</a>.</p><p>I&apos;m also a big fan of <strong>BDD</strong> and love <strong><a href="http://cukes.info/">Cucumber</a></strong> and it&apos;s <a href="https://github.com/cucumber/cucumber-jvm">version on the JVM</a>. It&apos;s <strong>not just a test framework</strong> but more of a <strong><a href="https://cucumber.pro/blog/2014/03/03/the-worlds-most-misunderstood-collaboration-tool.html">collaboration tool</a></strong>. That&apos;s one of the reasons why I much prefer it to just writing acceptance tests with JUnit.</p><p>Dropwizard provides some great <a href="http://www.dropwizard.io/manual/testing/">testing tools</a>. It comes with a nice <a href="https://github.com/junit-team/junit/wiki/Rules">JUnit Rule</a> named <a href="https://github.com/dropwizard/dropwizard/blob/master/dropwizard-testing/src/main/java/io/dropwizard/testing/junit/DropwizardAppRule.java">DropwizardAppRule</a> (previously DropwizardServiceRule). If you write your <a href="http://www.tomakehurst.com/all-in-one-test-environments-with-junit/">acceptance tests with JUnit</a> you can start/stop your app with the provided rule. You can mock your REST dependencies with <a href="http://wiremock.org/">WireMock</a> which also has a <a href="http://wiremock.org/getting-started.html#junit-4-x">JUnit rule</a>. What if you want the something similar but with Cucumber?</p><h3><a class="heading-anchor" name="no-cucumber-global-hooks" href="#no-cucumber-global-hooks">No Cucumber global hooks</a></h3><p>The first problem is that Cucumber-JVM and Cucumber has <strong>no support</strong> for hooking in a setup/teardown step <strong>before/after all your feature files</strong> are ran. It currently only supports @Before/@After hooks which run the annotated methods before/after each scenario. The workaround for this is described in detail in <a href="https://github.com/cucumber/cucumber-jvm/issues/515">cucumber-jvm#515</a> and involves adding a static field to your StepDefs class and adding <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html#addShutdownHook(java.lang.Thread">shutdownHook</a>).</p><p>Based on <a href="https://github.com/cucumber/cucumber-jvm/issues/672">cucumber-jvm#672</a> and <a href="https://github.com/cucumber/cucumber-jvm/issues/678">cucumber-jvm#678</a> we&apos;re getting <strong>@BeforeAll</strong> and <strong>@AfterAll</strong> hooks in an upcoming release.</p><h3><a class="heading-anchor" name="dropwizardapprule-is-junit-only" href="#dropwizardapprule-is-junit-only">DropwizardAppRule is JUnit only</a></h3><p>The second issue is that DropwizardAppRule is tied to JUnit and <strong>doesn&apos;t expose it&apos;s start/stop methods</strong>. Even if you run your Cucumber tests with JUnit you need functionality (port, environment, etc) from this rule in your StepDefs class so it&apos;s not likely to help.</p><p>I&apos;m generalizing DropWizardAppRule in <a href="https://github.com/dropwizard/dropwizard/issues/488">dropwizard#488</a> to enable support for test frameworks other than JUnit and Scala support as well. Whatch the issue if you&apos;re interested but it&apos;s going to be merged sometime after 0.7.0.</p><h3><a class="heading-anchor" name="solution-for-now" href="#solution-for-now">Solution for now</a></h3><p>In the meantime you can <strong>create your own <a href="https://gist.github.com/csabapalfi/9393015#file-dropwizardtestsupport-java">DropwizardTestSupport</a></strong> class and have to <strong>use <a href="https://gist.github.com/csabapalfi/9393015#file-examplestepdefs-java">the hack instead of @BeforeAll</a></strong>.</p><p>You should end up with something like this in your StepDefs class:</p><pre class="hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DropwizardTestSupport&lt;ExampleConfiguration&gt; service;

<span class="hljs-meta">@Before</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">if</span>(service==<span class="hljs-keyword">null</span>){
        service = <span class="hljs-keyword">new</span> DropwizardTestSupport(ExampleService.class,
                Resources.getResource(<span class="hljs-string">&quot;test.yml&quot;</span>).getPath());
        service.startIfRequired();
        <span class="hljs-comment">//Hack until @BeforAll is properly supported by Cucumber-JVM</span>
        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> Thread(){
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
                service.stop();
            }
        });
    }
}
</pre><p>This worked for me perfectly fine.</p><p><img src="https://ga-beacon.appspot.com/UA-29212656-1/dropwizard-and-cucumber?pixel" alt=""></p></article></body></html>